{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚ú® –ü–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>‚ú® –ü–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h1>
      <p>–ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—à–∏—Ö –ø–æ—Å—Ç–æ–≤ —Å –ò–ò –ø–æ–º–æ—â–Ω–∏–∫–æ–º</p>
      <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
    </header>

    <!-- –ü–æ–∏—Å–∫ -->
    <section class="search-section">
      <form method="get" class="search-form">
        <input type="text" name="query" value="{{ query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é..." />
        <button type="submit">üîç –ù–∞–π—Ç–∏</button>
      </form>
    </section>

    <!-- –ò–ò –ø–æ–º–æ—â–Ω–∏–∫ -->
    <section class="ai-section">
      <h2>ü§ñ –ò–ò –ü–æ–º–æ—â–Ω–∏–∫</h2>
      <form id="ai-form">
        <input type="text" id="ai-message" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —É –ò–ò..." required />
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
      <div id="ai-response" class="ai-response"></div>
    </section>



    <!-- –ü–æ—Å—Ç—ã -->
    <section class="posts-grid">
      {% for post in posts_list %}
      <article class="post-card">
        <h3>{{ post.title }}</h3>
        <p class="post-content" id="content-{{ forloop.counter }}">
  {% if post.text|length > 300 %}
    {{ post.text|slice:":300" }}...
    <button onclick="this.parentElement.innerHTML = '{{ post.text|escapejs|linebreaksbr }}';" class="read-more-btn">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</button>
  {% else %}
    {{ post.text|linebreaks }}
  {% endif %}
</p>

        <footer class="post-footer">
          <span class="likes" onclick="toggleLike(this)">‚ù§Ô∏è <span>0</span></span>
          <span class="time">
            {% if post.created_at %}
              {{ post.created_at|timesince }} –Ω–∞–∑–∞–¥
            {% else %}
              –ù–µ–¥–∞–≤–Ω–æ
            {% endif %}
          </span>
        </footer>
      </article>
      {% empty %}
      <div class="empty-state">
        {% if query %}
          <h2>üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h2>
          <p>–ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ query }}" –ø–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
        {% else %}
          <h2>üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
          <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!</p>
        {% endif %}
      </div>
      {% endfor %}
    </section>

    <button class="toggle-form-btn" onclick="toggleAddForm()">‚úèÔ∏è</button>
  </div>

  <script>
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
    }

    function toggleAddForm() {
      const form = document.getElementById('addPostForm');
      form.classList.toggle('form-hidden');
    }

    function toggleLike(el) {
      const span = el.querySelector('span');
      let count = parseInt(span.textContent);
      count = count === 0 ? 1 : 0;
      span.textContent = count;
      el.style.color = count > 0 ? '#e74c3c' : '#666';
    }

    function toggleReadMore(id) {
      const content = document.getElementById(`content-${id}`);
      const btn = content.nextElementSibling;
      content.classList.toggle('collapsed');
      btn.textContent = content.classList.contains('collapsed') ? '–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ' : '–°–∫—Ä—ã—Ç—å';
    }

    document.getElementById('ai-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const input = document.getElementById('ai-message');
      const responseBox = document.getElementById('ai-response');
      const message = input.value.trim();
      if (!message) return;

      responseBox.className = 'ai-response loading';
      responseBox.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...';

      try {
        const res = await fetch('/ai-chat/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        responseBox.className = 'ai-response';
        responseBox.textContent = data.success ? data.response : '–û—à–∏–±–∫–∞: ' + data.error;
      } catch {
        responseBox.className = 'ai-response error';
        responseBox.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.';
      }

      input.value = '';
    });
  </script>
</body>
</html>
